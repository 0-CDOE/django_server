{% extends 'base.html' %}

{% block content %}
<div class="container">
    <form id="questionForm" method="post" class="post-form my-3" enctype="multipart/form-data">
        {% csrf_token %}
        {% include "form_errors.html" %}

        {# 제목 입력 폼 #}
        <div class="form-group">
            <label for="id_subject">{{ form.subject.label }}</label>
            <input type="text" name="subject" id="id_subject" class="form-control"
                   value="{{ form.subject.value|default:'' }}" placeholder="제목을 입력하세요">
            {% for error in form.subject.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        {# 내용 입력 폼 #}
        <div class="form-group">
            <label for="id_content">{{ form.content.label }}</label>
            <textarea name="content" id="id_content" class="form-control" placeholder="내용을 입력하세요">{{ form.content.value|default:'' }}</textarea>
            {% for error in form.content.errors %}
                <div class="text-danger">{{ error }}</div>
            {% endfor %}
        </div>

        {# 이미지 업로드 필드를 가로로 나열 #}
        <div class="form-row d-flex justify-content-between">
            {# 이미지 업로드 필드 처리 (이미지1) #}
            {% if form.image1 %}
            <div class="form-group" style="flex-basis: 48%;">
                <label for="id_image1">{{ form.image1.label }}</label>
                <div id="drop_area_image1" class="border border-primary p-4 text-center" 
                     ondrop="handleDrop(event, 'id_image1', 'preview_image1', 'dropText1')" 
                     ondragover="handleDragOver(event)" style="cursor: pointer;">
                    <p id="dropText1" class="text-primary">Drag and Drop Image 1 Here or Click to Upload</p>
                    <img id="preview_image1" src="{{ initial_image1_url }}" alt="이미지1 미리보기" 
                         class="img-preview mt-3" 
                         style="display: {% if initial_image1_url %}block{% else %}none{% endif %};">
                </div>
                <input type="file" name="image1" id="id_image1" class="form-control-file mt-2 d-none" 
                       onchange="previewFile('id_image1', 'preview_image1', 'dropText1')">
                {% for error in form.image1.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}

            {# 이미지 업로드 필드 처리 (이미지2) #}
            {% if form.image2 %}
            <div class="form-group" style="flex-basis: 48%;">
                <label for="id_image2">{{ form.image2.label }}</label>
                <div id="drop_area_image2" class="border border-primary p-4 text-center" 
                     ondrop="handleDrop(event, 'id_image2', 'preview_image2', 'dropText2')" 
                     ondragover="handleDragOver(event)" style="cursor: pointer;">
                    <p id="dropText2" class="text-primary">Drag and Drop Image 2 Here or Click to Upload</p>
                    <img id="preview_image2" src="{{ initial_image2_url }}" alt="이미지2 미리보기" 
                         class="img-preview mt-3" 
                         style="display: {% if initial_image2_url %}block{% else %}none{% endif %};">
                </div>
                <input type="file" name="image2" id="id_image2" class="form-control-file mt-2 d-none" 
                       onchange="previewFile('id_image2', 'preview_image2', 'dropText2')">
                {% for error in form.image2.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
{% comment %} 
        {# 탐지기 선택 필드 (체크박스) #}
        {% if form.detectors %}
        <div class="form-group">
            <label>{{ form.detectors.label }}</label>
            <div class="form-check">
                {% for checkbox in form.detectors %}
                    <div class="form-check">
                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %} {% endcomment %}

        {% comment %} {# 예측기 선택 필드 (체크박스) #}
        {% if form.predictors %}
        <div class="form-group">
            <label>{{ form.predictors.label }}</label>
            <div class="form-check">
                {% for checkbox in form.predictors %}
                    <div class="form-check">
                        {{ checkbox.tag }} {{ checkbox.choice_label }}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %} {% endcomment %}

        {# 등록/수정 버튼 #}
        <input type="submit" value="{{ form.instance.pk|yesno:'질문 수정,질문 등록' }}" class="btn btn-primary">
    </form>
</div>
{% endblock %}

{% block script %}
<script>
    function previewFile(inputId, previewId, dropTextId) {
        var fileInput = document.getElementById(inputId);
        var previewImage = document.getElementById(previewId);
        var dropText = document.getElementById(dropTextId);
        
        if (fileInput.files && fileInput.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                dropText.style.display = 'none';  // DragNDrop 텍스트 숨김
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            previewImage.src = "#";
            previewImage.style.display = 'none';
            dropText.style.display = 'block';  // DragNDrop 텍스트 표시
        }
    }

    function handleDrop(event, inputId, previewId, dropTextId) {
        event.preventDefault();
        var fileInput = document.getElementById(inputId);
        fileInput.files = event.dataTransfer.files;
        previewFile(inputId, previewId, dropTextId);
    }

    function handleDragOver(event) {
        event.preventDefault();
    }

    // 클릭 시 파일 선택창 열기 (이미지 업로드 필드를 자동으로 추가)
    document.querySelectorAll("[id^=drop_area]").forEach(dropArea => {
        dropArea.addEventListener('click', function() {
            const fileInputId = dropArea.id.replace('drop_area_', 'id_');
            document.getElementById(fileInputId).click();
        });
    });
</script>

<style>
    .img-preview {
        width: 200px;
        height: 200px;
        object-fit: contain;
        border: 1px solid #ccc;d
        padding: 5px;
    }
    .form-row {
        display: flex;
        justify-content: space-between;
    }
</style>
{% endblock %}
